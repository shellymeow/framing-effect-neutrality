<!DOCTYPE html>
<html>
    <head>
        <title>Decision Making Study</title>
        <script src="https://unpkg.com/jspsych@7.3.4"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
        <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    </head>
    <body></body>
    <script>
        // Initialize jsPsych
        const jsPsych = initJsPsych({
            on_finish: function() {
                jsPsych.data.displayData();
            }
        });
        const timeline = [];

        // Common constants
        const NEUTRAL_OPTION = 'I would like to flip a coin';

        // Scenario definitions
        const scenarios = {
            asian_disease: {
                name: 'AsianDisease',
                prompt: `
                    <p style="text-align: left;">Recently, a dangerous new disease has been going around. 
                    Without medicine, 600,000 people will die from it.</p>
                    <p style="text-align: left;">In order to save these people, 
                    two types of medicine are being made.</p>
                    <p style="text-align: left;">Now you have to choose which one to use.</p>
                `,
                options: {
                    a: '400,000 people will die.',
                    b: 'There is a 33.3% chance that no one will die and a 66.6% chance that 600,000 will die.'
                }
            },
            damaged_painting: {
                name: 'DamagedPainting',
                prompt: `
                    <p style="text-align: left;">A large museum is damaged by fire. 
                    1,000 famous paintings are at the risk of being destroyed.</p>
                    <p style="text-align: left;">Two alternative programs have been proposed to restore the paintings.</p>
                    <p style="text-align: left;">Now you have to choose which one to follow, 
                    or you may indicate if you are unsure.</p>
                `,
                options: {
                    a: '600 paintings will be destroyed.',
                    b: 'There is a 40% chance that no painting will be destroyed and a 60% chance that 1000 paintings will be destroyed.'
                }
            },
            computer_virus: {
                name: 'ComputerVirus',
                prompt: `
                    <p style="text-align: left;">There is a new computer virus which can infect certain computer software. 
                    At the moment, this software is installed on 2 000 000 computers.</p>
                    <p style="text-align: left;">Two types of antivirus software are being developed.</p>
                    <p style="text-align: left;">Now you have to choose which one to use, 
                    or you may indicate if you are unsure.</p>
                `,
                options: {
                    a: '1,200,000 computers will be infected.',
                    b: 'There is a 40% chance that no computer will be infected and a 60% chance that 2,000,000 computers will be infected.'
                }
            }
        };

        // Helper function to create a question trial
        function createQuestionTrial(scenario) {
            return {
                type: jsPsychSurveyMultiChoice,
                questions: [{
                    prompt: scenario.prompt,
                    name: scenario.name,
                    options: [scenario.options.a, scenario.options.b, NEUTRAL_OPTION],
                    required: true
                }]
            };
        }

        // Helper function to create feedback trial
        function createFeedbackTrial(scenario, optionText) {
            return {
                type: jsPsychSurveyMultiChoice,
                questions: [{
                    prompt: `
                        <p>You chose:</p>
                        <p>${optionText}</p>
                        <p>Do you want to <b>change</b> your decision?</p>
                    `,
                    name: `Feedback${scenario.name}`,
                    options: ['Yes', 'No'],
                    required: true
                }]
            };
        }

        // Helper function to create conditional feedback
        function createConditionalFeedback(scenario, optionText, feedbackTrial) {
            return {
                timeline: [feedbackTrial],
                conditional_function: function() {
                    const lastResponse = jsPsych.data.get().last(1).values()[0].response[scenario.name];
                    return lastResponse === optionText;
                }
            };
        }

        // Add trials for each scenario
        Object.values(scenarios).forEach(scenario => {
            // Add main question
            timeline.push(createQuestionTrial(scenario));

            // Add feedback for each option
            const feedbackA = createFeedbackTrial(scenario, scenario.options.a);
            const feedbackB = createFeedbackTrial(scenario, scenario.options.b);

            timeline.push(createConditionalFeedback(scenario, scenario.options.a, feedbackA));
            timeline.push(createConditionalFeedback(scenario, scenario.options.b, feedbackB));
            timeline.push(createConditionalFeedback(scenario, NEUTRAL_OPTION, feedbackB)); // Uses option B feedback for neutral
        });

         /** ---------------------  2. Survey ------------------------------ */

         timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            Thank you for participating! You will now complete a survey.
            <br><br>
            Press any key to proceed to the survey.
            `,
        });

        // Define Likert scale
        var likert_scale = [
            "1<br>Strongly Disagree", 
            "2", 
            "3", 
            "4", 
            "5<br>Strongly Agree"
        ];

        // Define the survey trials
        var survey_trial = {
            type: jsPsychSurveyLikert,
            questions: [
                {prompt: "I think the question doesn’t matter to me.", name: 'Indifference', labels: likert_scale},
                {prompt: "I feel it’s not my responsibility to make a choice in this situation.", name: 'Responsibility', labels: likert_scale},
                {prompt: "I think I would need more information to decide..", name: 'InformationSeeking', labels: likert_scale},
                ],
        };

        timeline.push(survey_trial)

        // Start the experiment
        jsPsych.run(timeline);
    </script>
</html>

