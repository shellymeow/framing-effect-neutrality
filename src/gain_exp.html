<!DOCTYPE html>
<html>
    <head>
        <title>Decision Making Study</title>
        <script src="https://unpkg.com/jspsych@7.3.4"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
        <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    </head>
    <body></body>
    <script>
        // Initialize jsPsych
        const jsPsych = initJsPsych({
            on_finish: function() {
                jsPsych.data.displayData();
            }
        });
        const timeline = [];

        /** ---------------------  1. Task Setup  ------------------------------ */
        // Common constants
        const NEUTRAL_OPTION = `I can't decide and would like to flip a coin`;

        // Scenario definitions
        const scenarios = {
            asian_disease: {
                name: 'AsianDisease',
                prompt: `
                    <p style="text-align: left;">Recently, a dangerous new disease has been going around. 
                    Without medicine, 600,000 people will die from it.</p>
                    <p style="text-align: left;">In order to save these people, 
                    two types of medicine are being made.</p>
                    <p style="text-align: left;">Now you have to choose which one to use.</p>
                `,
                options: {
                    a: '<b>200,000</b> people will be <b>saved</b>.',
                    b: 'There is a <b>33.3% chance</b> that <b>600,000</b> people will be <b>saved</b> and a <b>66.6% chance</b> that <b>no one</b> will be <b>saved</b>.'
                }
            },
            unemployment: {
                name: 'Unemployment',
                prompt: `
                    <p style="text-align: left;">
                    Imagine that the government is preparing to respond to an economic crisis. 
                    The government expects that <b>100 000</b> people will <b>lose</b> their jobs.</p>
                    <p style="text-align: left;">The government is considering two programs to reduce unemployment.</p>
                    <p style="text-align: left;">Now you have to choose which one to follow.</p>
                `,
                options: {
                    a: '<b>50 000</b> jobs will be <b>saved</b>.',
                    b: 'There is a <b>80% chance</b> that <b>100 000</b> jobs will be <b>saved</b> and a <b>20% chance</b> that <b>no jobs</b> will be <b>saved</b>.'
                }
            },
            damaged_painting: {
                name: 'DamagedPainting',
                prompt: `
                    <p style="text-align: left;">A large museum is damaged by fire. 
                    <b>1,000</b> famous paintings are at the risk of being destroyed.</p>
                    <p style="text-align: left;">Two alternative programs have been proposed to restore the paintings.</p>
                    <p style="text-align: left;">Now you have to choose which one to follow.</p>
                `,
                options: {
                    a: '<b>400</b> paintings will be <b>saved</b>.',
                    b: 'There is a <b>40% chance</b> that <b>1,000</b> paintings will be <b>saved</b> and a <b>60% chance</b>. that no painting will be <b>saved</b>.'
                }
            },
            computer_virus: {
                name: 'ComputerVirus',
                prompt: `
                    <p style="text-align: left;">There is a new computer virus which can infect certain computer software. 
                    At the moment, this software is installed on 2 000 000 computers.</p>
                    <p style="text-align: left;">Two types of antivirus software are being developed.</p>
                    <p style="text-align: left;">Now you have to choose which one to use.</p>
                `,
                options: {
                    a: '800,000 computers will remain virus-free.',
                    b: 'There is a 40% chance that 2,000,000 computers will remain virus-free and a 60% chance that no computer will remain virus-free.'
                }
            }
        };

        // Helper function to create a question trial
        function createQuestionTrial(scenario) {
            return {
                type: jsPsychSurveyMultiChoice,
                questions: [{
                    prompt: scenario.prompt,
                    name: scenario.name,
                    options: [scenario.options.a, scenario.options.b, NEUTRAL_OPTION],
                    required: true
                }]
            };
        }

        // Helper function to create feedback trial
        function createFeedbackTrial(scenario, optionText) {
            return {
                type: jsPsychSurveyMultiChoice,
                questions: [{
                    prompt: `
                        <p>You chose:</p>
                        <p>${optionText}</p>
                        <p>Do you want to <b>change</b> your decision?</p>
                    `,
                    name: `Feedback${scenario.name}`,
                    options: ['Yes', 'No'],
                    required: true
                }]
            };
        }

        // Helper function to create conditional feedback
        function createConditionalFeedback(scenario, optionText, feedbackTrial) {
            return {
                timeline: [feedbackTrial],
                conditional_function: function() {
                    const lastResponse = jsPsych.data.get().last(1).values()[0].response[scenario.name];
                    return lastResponse === optionText;
                }
            };
        }

        // Add trials for each scenario
        Object.values(scenarios).forEach(scenario => {
            // Add main question
            timeline.push(createQuestionTrial(scenario));

            // Add feedback for each option
            const feedbackA = createFeedbackTrial(scenario, scenario.options.a);
            const feedbackB = createFeedbackTrial(scenario, scenario.options.b);

            timeline.push(createConditionalFeedback(scenario, scenario.options.a, feedbackA));
            timeline.push(createConditionalFeedback(scenario, scenario.options.b, feedbackB));
            timeline.push(createConditionalFeedback(scenario, NEUTRAL_OPTION, feedbackB)); // Uses option B feedback for neutral
        });

        /** ---------------------  2. Survey ------------------------------ */
        
        //Survey prompt
        const survey_prompt = 'Thank you for participating! You will now complete a survey.<br><br>Press the button to proceed to the survey.';
        timeline.push({
            type: jsPsychHtmlButtonResponse,
            stimulus: survey_prompt,
            choices: ['Continue']
        });

        // Define Likert scale
        var likert_scale = [
            "1<br>Strongly Disagree", 
            "2", 
            "3", 
            "4", 
            "5<br>Strongly Agree"
        ];

        // Define the survey trials
        var survey_trial = {
            type: jsPsychSurveyLikert,
            questions: [
                {prompt: "I think these questions do not matter to me.", name: 'Indifference', labels: likert_scale},
                {prompt: "I feel it is not my responsibility to make a choice in these situations.", name: 'Responsibility', labels: likert_scale},
                {prompt: "I think I would need more information to make my decisions.", name: 'InformationSeeking', labels: likert_scale},
                ],
        };

        timeline.push(survey_trial)

        // Start the experiment
        jsPsych.run(timeline);
    </script>
</html>

